/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * <h2><center>&copy; Copyright (c) 2020 STMicroelectronics.
 * All rights reserved.</center></h2>
 *
 * This software component is licensed by ST under BSD 3-Clause license,
 * the "License"; You may not use this file except in compliance with the
 * License. You may obtain a copy of the License at:
 *                        opensource.org/licenses/BSD-3-Clause
 *
 ******************************************************************************
 */

#if !defined(__SOFT_FP__) && defined(__ARM_FP)
  #warning "FPU is not initialized, but the project is compiling for an FPU. Please initialize the FPU before use."
#endif

/*Keyboard 4x4 connection
  			C1-PB3
  			 ^ C2-PA10
 			 |	^ C3-PA2
 			 |	|  ^  C4-PA3
 			 |	|  |  ^
R1-	PA8---->(1)(2)(3)(A)
R2-	PB10--->(4)(5)(6)(B)
R3-	PB4---->(7)(8)(9)(C)
R4-	PB5---->(*)(0)(#)(D)
*/
#include<stdint.h>
#include<stdio.h>

void delay(void)
{
	for(uint32_t i=0; i<500000; i++);
}

int main(void)
{
//***********Peripheral register addresses
//6.3.10 RCC AHB1 peripheral clock enable register (RCC_AHB1ENR)
	uint32_t volatile *const pClockCtrlReg=(uint32_t*) (0x40023800+0x30);	//6.3.10  (RCC_AHB1ENR)
//7.4.1 GPIO port mode register (GPIOx_MODER) (x = A..H)
	uint32_t volatile *const pPortAModeReg=(uint32_t*)0x40020000;
	uint32_t volatile *const pPortBModeReg=(uint32_t*)0x40020400;
//  7.4.4 GPIO port pull-up/pull-down register (GPIOx_PUPDR) (x = A..H)
	uint32_t volatile *const pPortApullUpDownlReg=(uint32_t*)(0x40020000+0x0C);
	uint32_t volatile *const pPortBpullUpDownlReg=(uint32_t*)(0x40020400+0x0C);
//7.4.5 GPIO port input data register (GPIOx_IDR) (x = A..H)
	uint32_t volatile *const pPortAInputReg=(uint32_t*)(0x40020000+0x10);
	uint32_t volatile *const pPortBInputReg=(uint32_t*)(0x40020400+0x10);
//7.4.6 GPIO port output data register (GPIOx_ODR) (x = A..H)
	uint32_t volatile *const pPortAOutputReg=(uint32_t*)(0x40020000+0x14);
	uint32_t volatile *const pPortBOutputReg=(uint32_t*)(0x40020400+0x14);

//************Cnable the peripheral clock of GPIO* peripheral
	*pClockCtrlReg |= (1<<0); 	//Enable Clock on PortA
	*pClockCtrlReg |= (1<<1);	//Enable Clock on PortB
	*pClockCtrlReg |= (1<<2);	//Enable Clock on PortC
//************Configure outputs (rows)
	//Configure PA8 IO pin as output
	*pPortAModeReg |=(1<<16);	//
	//Configure PB10 IO pin as output
	*pPortBModeReg |=(1<<20);	//set 20 position
	//Configure PB4 IO pin as output
	*pPortBModeReg &=~(1<<9);	//clear 9 position
	*pPortBModeReg |=(1<<8);	//set 8 position
	//Configure PB5 IO pin as output
	*pPortBModeReg |=(1<<10);	//set 10 position

//configure output for led
	//Configure PA5 IO pin as output
		//a. clear 10 and 11 position
	*pPortAModeReg &=~(3<<10);//*pPortAModeReg &= 0xFFFFF3FF;
		//b make 10 position as 1 set
	*pPortAModeReg |= (1<<10);//*pPortAModeReg |= 0x00000400;

//************Configure inputs (columns)
	//Configure PA10 IO pin as input
	*pPortAModeReg &=~(3<<20);	//clear 20;21 position
	//Configure PA2 IO pin as input
	*pPortAModeReg &=~(3<<4);	//clear 4;5 position
	//Configure PA3 IO pin as input
	*pPortAModeReg &=~(3<<6);	//clear 6;7 position
	//Configure PB3 IO pin as input
	*pPortBModeReg &=~(3<<6);	//clear 6;7 position
//***********Enable internal pull-up resistors for outputs
	//Configure PA10 IO pin with pull-up
	*pPortApullUpDownlReg |=(1<<20);	//set 21 position
	//Configure PA2 IO pin with pull-up
	*pPortApullUpDownlReg |=(1<<4);		//set 4 position
	//Configure PA3 IO pin with pull-up
	*pPortApullUpDownlReg |=(1<<6);		//set 6 position
	//Configure PB3 IO pin with pull-up
	*pPortBpullUpDownlReg |=(1<<6);		//set 6 position

//**********BEGIN***********
	printf("proverca\n");

while(1){
//***********Make all (outputs) rows HIGH
	//Configure PB10 IO pin as 1
		*pPortBOutputReg |=(1<<10);	//
	//Configure PB4 IO pin as 1
		*pPortBOutputReg |=(1<<4);	//
	//Configure PB5 IO pin as 1
		*pPortBOutputReg |=(1<<5);	//
	//Configure PA8 IO pin as 1
		*pPortAOutputReg |=(1<<8);	//
//**********Make R1 LOW PA8
	//Configure PA8 IO pin as 0 /Row 1
		*pPortAOutputReg &=~(1<<8);	//R1
//scan the columns
	//check C1 PB3 low or high
		if(!(*pPortBInputReg & (1<<3))){
			//key is pressed
			delay();
			printf("pressed key 1\n");
		}//endIF
	//check C2-PA10 low or high
		if(!(*pPortAInputReg & (1<<10))){
			//key is pressed
			delay();
			printf("pressed key 2\n");
		}//endIF
	//check C3-PA2 low or high
		if(!(*pPortAInputReg & (1<<2))){
			//key is pressed
			delay();
			printf("pressed key 3\n");
		}//endIF
	//check C4-PA2 low or high
		if(!(*pPortAInputReg & (1<<3))){
			//key is pressed
			delay();
			printf("pressed key A\n");
		}//endIF

		//Configure PA8 IO pin as 1
			*pPortAOutputReg |=(1<<8);	//
//**********Make R2-PB10 low
		//Configure PB10 IO pin as 0
			*pPortBOutputReg &=~(1<<10);//R2

			//scan the columns
				//check C1 PB3 low or high
					if(!(*pPortBInputReg & (1<<3))){
						//key is pressed
						delay();
						printf("pressed key 4\n");
					}//endIF
				//check C2-PA10 low or high
					if(!(*pPortAInputReg & (1<<10))){
						//key is pressed
						delay();
						printf("pressed key 5\n");
					}//endIF
				//check C3-PA2 low or high
					if(!(*pPortAInputReg & (1<<2))){
						//key is pressed
						delay();
						printf("pressed key 6\n");
					}//endIF
				//check C4-PA2 low or high
					if(!(*pPortAInputReg & (1<<3))){
						//key is pressed
						delay();
						printf("pressed key B\n");
					}//endIF
}//end while
}//End MAIN
